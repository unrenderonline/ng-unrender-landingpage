<div class="w-full h-[650px] bg-white rounded-xl overflow-hidden border border-slate-200 shadow-lg flex flex-col font-sans select-none">
  
  <!-- AI Agent Navbar -->
  <div class="w-full h-16 bg-white border-b border-slate-200 flex items-center px-4 justify-between shrink-0 z-20 relative">
    <!-- Left: Agent Identity -->
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-unrender-purple rounded-full flex items-center justify-center shadow-lg shadow-indigo-500/30 relative">
        <fa-icon [icon]="faRobot" class="text-white text-lg"></fa-icon>
        <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white animate-pulse"></div>
      </div>
      <div class="hidden sm:block">
        <h2 class="text-unrender-purple font-bold text-sm leading-tight">Agente Local</h2>
        <div class="text-[10px] text-slate-500">Online ‚Ä¢ NPU Ativa</div>
      </div>
    </div>

    <!-- Center: Chat / Status -->
    <div class="flex-1 mx-4 h-10 bg-gray-100 rounded-lg border border-slate-200 flex items-center px-3 overflow-hidden relative group">
      
      <!-- Chat History (Visible when not typing) -->
      <div #chatContainer class="flex-1 overflow-y-auto scrollbar-hide h-full flex flex-col justify-center pr-8 transition-opacity duration-200"
           [class.opacity-0]="isInputFocused || currentMessage.length > 0">
        <div *ngFor="let msg of messages" class="text-sm py-0.5" [ngClass]="msg.sender === 'user' ? 'text-right text-unrender-purple font-medium' : 'text-left text-slate-600'">
          {{ msg.text }}
        </div>
      </div>

      <!-- Input Field (Overlay) -->
      <input type="text" 
             [(ngModel)]="currentMessage" 
             (keydown.enter)="sendMessage()"
             (focus)="isInputFocused = true"
             (blur)="isInputFocused = false"
             placeholder="Digite um comando..."
             class="absolute inset-0 w-full h-full bg-transparent text-slate-800 text-sm px-3 outline-none placeholder-slate-400"
             [class.bg-white]="isInputFocused || currentMessage.length > 0"
             [class.opacity-100]="isInputFocused || currentMessage.length > 0"
             [class.opacity-0]="!isInputFocused && currentMessage.length === 0">

      <!-- Processing Indicator -->
      <div *ngIf="isProcessing" class="absolute right-2 top-1/2 transform -translate-y-1/2 flex gap-1 pointer-events-none z-10">
        <div class="w-1 h-1 bg-unrender-purple rounded-full animate-bounce" style="animation-delay: 0s"></div>
        <div class="w-1 h-1 bg-unrender-purple rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
        <div class="w-1 h-1 bg-unrender-purple rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
      </div>
    </div>

    <!-- Right: Quick Actions -->
    <div class="flex items-center gap-2">
      <button (click)="triggerScenario('find-keys')" 
              [disabled]="isProcessing"
              class="px-3 py-1.5 bg-white hover:bg-gray-50 rounded text-xs text-slate-700 transition-colors flex items-center gap-2 border border-slate-200 disabled:opacity-50 shadow-sm">
        <fa-icon [icon]="faSearch"></fa-icon> <span class="hidden sm:inline">Chaves</span>
      </button>
      <button (click)="triggerScenario('good-night')" 
              [disabled]="isProcessing"
              class="px-3 py-1.5 bg-white hover:bg-gray-50 rounded text-xs text-slate-700 transition-colors flex items-center gap-2 border border-slate-200 disabled:opacity-50 shadow-sm">
        <fa-icon [icon]="faHome"></fa-icon> <span class="hidden sm:inline">Boa Noite</span>
      </button>
    </div>
  </div>

  <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
    <!-- Controls Panel -->
    <div class="w-full md:w-1/3 bg-white border-r border-slate-200 p-6 overflow-y-auto">
      <h2 class="text-xl font-bold text-unrender-purple mb-6 flex items-center gap-2">
        <span class="text-unrender-accent">üè†</span> Controles
      </h2>

      <div *ngFor="let room of rooms" class="mb-6">
        <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-wider mb-2">{{ room }}</h3>
        <div class="space-y-2">
          <div *ngFor="let device of getDevicesByRoom(room)" 
               (click)="toggleDevice(device)"
               class="flex items-center justify-between p-2 rounded-lg cursor-pointer transition-all duration-200 border gap-2"
               [ngClass]="device.isOn ? 'bg-unrender-purple/10 border-unrender-purple/30 shadow-[0_0_15px_rgba(16,5,28,0.1)]' : 'bg-gray-50 border-slate-200 hover:bg-gray-100'">
            
            <div class="flex items-center gap-3 flex-1 min-w-0">
              <div class="w-8 h-8 rounded-full flex items-center justify-center transition-colors duration-200 text-sm shrink-0"
                   [ngClass]="device.isOn || device.type === 'camera' ? 'bg-unrender-purple text-white' : 'bg-slate-200 text-slate-500'">
                <fa-icon [icon]="device.icon"></fa-icon>
              </div>
              <div class="min-w-0">
                <div class="text-slate-800 font-medium text-xs sm:text-sm truncate">{{ device.name }}</div>
                <div class="text-[10px] text-slate-500 truncate" *ngIf="device.type === 'ac' && device.isOn">
                  {{ device.value }}¬∞C ‚Ä¢ Resfriando
                </div>
              </div>
            </div>

            <!-- Toggle Switch (Hidden for Camera) -->
            <div *ngIf="device.type !== 'camera'" class="w-8 h-4 rounded-full relative transition-colors duration-200 shrink-0"
                 [ngClass]="device.isOn ? 'bg-unrender-purple' : 'bg-slate-300'">
              <div class="absolute top-0.5 w-3 h-3 bg-white rounded-full transition-transform duration-200 shadow-sm"
                   [style.left.px]="device.isOn ? 18 : 2"></div>
            </div>
            
            <!-- View Button for Camera -->
            <div *ngIf="device.type === 'camera'" class="px-2 py-0.5 bg-slate-200 hover:bg-slate-300 rounded text-[10px] text-slate-700 font-bold transition-colors shrink-0">
              VER
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Visual Floor Plan -->
    <div class="w-full md:w-2/3 bg-gray-50 relative p-4 flex items-center justify-center">
      <!-- Floor Plan Container -->
      <div class="relative w-full max-w-lg aspect-square bg-white rounded-2xl border-4 border-slate-200 shadow-xl overflow-hidden">
        
        <!-- Rooms Grid -->
        <div class="absolute inset-0 grid grid-cols-2 grid-rows-2 gap-2 p-2 bg-gray-100">
          
          <!-- Sala de Estar (Top Left) -->
          <div class="bg-white rounded-xl relative p-4 transition-colors duration-500 overflow-hidden"
               [ngClass]="{'bg-gray-50': getDevicesByRoom('Sala de Estar')[0].isOn}"> <!-- Light effect -->
            <div class="absolute top-2 left-2 text-xs text-slate-400 font-bold uppercase z-10">Sala</div>
            
            <!-- Furniture -->
            <div class="absolute bottom-4 left-4 w-24 h-8 bg-gray-200 rounded-md"></div> <!-- Sofa -->
            <div class="absolute top-1/2 right-2 w-2 h-16 bg-slate-800 rounded-sm border border-slate-300 transition-shadow duration-300 transform -translate-y-1/2"
                 [ngClass]="{'shadow-[0_0_30px_rgba(59,130,246,0.6)] bg-blue-900': getDevicesByRoom('Sala de Estar')[1].isOn}"></div> <!-- TV -->
            
            <!-- AC Unit -->
            <div class="absolute top-2 right-8 w-12 h-4 bg-white border border-slate-200 rounded-sm transition-all duration-300 flex items-center justify-center gap-1 z-10"
                 [ngClass]="{'shadow-[0_0_15px_rgba(59,130,246,0.4)]': getDevicesByRoom('Sala de Estar')[2].isOn}">
               <div class="w-1 h-1 bg-green-500 rounded-full" *ngIf="getDevicesByRoom('Sala de Estar')[2].isOn"></div>
            </div>
            
            <!-- AC Air Flow -->
            <div *ngIf="getDevicesByRoom('Sala de Estar')[2].isOn" class="absolute top-6 right-8 w-12 h-20 flex justify-around overflow-hidden pointer-events-none">
               <div class="w-0.5 h-4 bg-blue-400/30 rounded-full animate-air-flow-down" style="animation-delay: 0s;"></div>
               <div class="w-0.5 h-4 bg-blue-400/30 rounded-full animate-air-flow-down" style="animation-delay: 0.3s;"></div>
               <div class="w-0.5 h-4 bg-blue-400/30 rounded-full animate-air-flow-down" style="animation-delay: 0.6s;"></div>
            </div>

            <!-- TV Light Emission -->
            <div *ngIf="getDevicesByRoom('Sala de Estar')[1].isOn" 
                 class="absolute right-4 w-40 h-32 transform -translate-y-1/2 bg-gradient-to-l from-blue-400/30 to-transparent blur-xl animate-tv-flicker pointer-events-none"
                 style="top: 23%; clip-path: polygon(100% 25%, 0% 0%, 0% 100%, 100% 75%);"></div>

            <!-- Light Source -->
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-4 h-4 rounded-full transition-all duration-300"
                 [ngClass]="getDevicesByRoom('Sala de Estar')[0].isOn ? 'bg-yellow-200 shadow-[0_0_60px_30px_rgba(253,224,71,0.15)]' : 'bg-gray-300'"></div>

            <!-- Scanning Overlay -->
            <div *ngIf="scanningRoom === 'Sala de Estar'" class="absolute inset-0 bg-unrender-accent/10 z-20 flex items-center justify-center pointer-events-none">
              <div class="w-full h-0.5 bg-unrender-accent/50 absolute top-0 animate-scan-line"></div>
              <div class="text-unrender-accent font-mono text-[10px] bg-white/80 px-2 rounded border border-unrender-accent/20">ANALISANDO...</div>
            </div>

            <!-- Detection Box (Keys) -->
            <div *ngIf="detectedItem && detectedItem.label === 'Chaves'" 
                 class="absolute w-6 h-6 border-2 border-unrender-accent rounded z-30 animate-ping-once"
                 style="bottom: 1.5rem; left: 2.5rem;">
               <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-unrender-accent text-white text-[8px] font-bold px-1 rounded whitespace-nowrap">
                 CHAVES
               </div>
            </div>
          </div>

          <!-- Cozinha (Top Right) -->
          <div class="bg-white rounded-xl relative p-4 transition-colors duration-500 overflow-hidden"
               [ngClass]="{'bg-gray-50': getDevicesByRoom('Cozinha')[0].isOn}">
            <div class="absolute top-2 left-2 text-xs text-slate-400 font-bold uppercase z-10">Cozinha</div>
            
            <!-- Furniture -->
            <div class="absolute bottom-0 right-0 w-24 h-12 bg-gray-200 rounded-tl-xl"></div> <!-- Counter -->
            
            <!-- Fan -->
            <div class="absolute top-4 right-4 text-slate-300 transition-all duration-1000 z-10"
                 [ngClass]="{'animate-spin text-blue-400': getDevicesByRoom('Cozinha')[1].isOn}">
              <fa-icon [icon]="faFan" size="lg"></fa-icon>
            </div>
            
            <!-- Fan Air Flow -->
            <div *ngIf="getDevicesByRoom('Cozinha')[1].isOn" class="absolute top-[-1.15rem] right-[-0.5rem] w-20 h-20 pointer-events-none">
               <div class="absolute top-1/2 left-1/2 w-1 h-4 bg-slate-400/20 rounded-full animate-air-flow-spin" style="animation-delay: 0s;"></div>
               <div class="absolute top-1/2 left-1/2 w-1 h-4 bg-slate-400/20 rounded-full animate-air-flow-spin" style="animation-delay: 0.2s;"></div>
               <div class="absolute top-1/2 left-1/2 w-1 h-4 bg-slate-400/20 rounded-full animate-air-flow-spin" style="animation-delay: 0.4s;"></div>
            </div>

            <!-- Light Source -->
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-4 h-4 rounded-full transition-all duration-300"
                 [ngClass]="getDevicesByRoom('Cozinha')[0].isOn ? 'bg-yellow-200 shadow-[0_0_60px_30px_rgba(253,224,71,0.15)]' : 'bg-gray-300'"></div>

            <!-- Scanning Overlay -->
            <div *ngIf="scanningRoom === 'Cozinha'" class="absolute inset-0 bg-unrender-accent/10 z-20 flex items-center justify-center pointer-events-none">
              <div class="w-full h-0.5 bg-unrender-accent/50 absolute top-0 animate-scan-line"></div>
              <div class="text-unrender-accent font-mono text-[10px] bg-white/80 px-2 rounded border border-unrender-accent/20">ANALISANDO...</div>
            </div>
          </div>

          <!-- Quarto (Bottom Left) -->
          <div class="bg-white rounded-xl relative p-4 transition-colors duration-500 overflow-hidden"
               [ngClass]="{'bg-gray-50': getDevicesByRoom('Quarto')[0].isOn}">
            <div class="absolute top-2 left-2 text-xs text-slate-400 font-bold uppercase z-10">Quarto</div>
            
            <!-- Furniture -->
            <div class="absolute bottom-4 right-4 w-20 h-24 bg-gray-200 rounded-md border-t-4 border-gray-300"></div> <!-- Bed -->
            
            <!-- AC Unit -->
            <div class="absolute top-2 right-8 w-12 h-4 bg-white border border-slate-200 rounded-sm transition-all duration-300 flex items-center justify-center gap-1 z-10"
                 [ngClass]="{'shadow-[0_0_15px_rgba(59,130,246,0.4)]': getDevicesByRoom('Quarto')[1].isOn}">
               <div class="w-1 h-1 bg-green-500 rounded-full" *ngIf="getDevicesByRoom('Quarto')[1].isOn"></div>
            </div>
            
            <!-- AC Air Flow -->
            <div *ngIf="getDevicesByRoom('Quarto')[1].isOn" class="absolute top-6 right-8 w-12 h-20 flex justify-around overflow-hidden pointer-events-none">
               <div class="w-0.5 h-4 bg-blue-400/30 rounded-full animate-air-flow-down" style="animation-delay: 0s;"></div>
               <div class="w-0.5 h-4 bg-blue-400/30 rounded-full animate-air-flow-down" style="animation-delay: 0.3s;"></div>
               <div class="w-0.5 h-4 bg-blue-400/30 rounded-full animate-air-flow-down" style="animation-delay: 0.6s;"></div>
            </div>

            <!-- Light Source -->
            <div class="absolute bottom-12 right-2 w-3 h-3 rounded-full transition-all duration-300"
                 [ngClass]="getDevicesByRoom('Quarto')[0].isOn ? 'bg-yellow-200 shadow-[0_0_40px_20px_rgba(253,224,71,0.15)]' : 'bg-gray-300'"></div>

            <!-- Scanning Overlay -->
            <div *ngIf="scanningRoom === 'Quarto'" class="absolute inset-0 bg-unrender-accent/10 z-20 flex items-center justify-center pointer-events-none">
              <div class="w-full h-0.5 bg-unrender-accent/50 absolute top-0 animate-scan-line"></div>
              <div class="text-unrender-accent font-mono text-[10px] bg-white/80 px-2 rounded border border-unrender-accent/20">ANALISANDO...</div>
            </div>
          </div>

          <!-- Escrit√≥rio (Bottom Right) -->
          <div class="bg-white rounded-xl relative p-4 transition-colors duration-500 overflow-hidden"
               [ngClass]="{'bg-gray-50': getDevicesByRoom('Escrit√≥rio')[0].isOn}">
            <div class="absolute top-2 left-2 text-xs text-slate-400 font-bold uppercase z-10">Escrit√≥rio</div>
            
            <!-- Furniture -->
            <div class="absolute top-1/2 left-4 w-16 h-8 bg-gray-200 rounded-md"></div> <!-- Desk -->
            
            <div class="absolute top-2 right-2 text-red-500 cursor-pointer hover:text-red-600 transition-colors"
                 (click)="activeCameraFeed = 'c1'; $event.stopPropagation()">
              <fa-icon [icon]="faVideo"></fa-icon>
            </div>

            <!-- Light Source -->
            <div class="absolute top-1/2 left-8 w-3 h-3 rounded-full transition-all duration-300"
                 [ngClass]="getDevicesByRoom('Escrit√≥rio')[0].isOn ? 'bg-yellow-200 shadow-[0_0_40px_20px_rgba(253,224,71,0.15)]' : 'bg-gray-300'"></div>

            <!-- Scanning Overlay -->
            <div *ngIf="scanningRoom === 'Escrit√≥rio'" class="absolute inset-0 bg-unrender-accent/10 z-20 flex items-center justify-center pointer-events-none">
              <div class="w-full h-0.5 bg-unrender-accent/50 absolute top-0 animate-scan-line"></div>
              <div class="text-unrender-accent font-mono text-[10px] bg-white/80 px-2 rounded border border-unrender-accent/20">ANALISANDO...</div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Camera Feed Overlay -->
  <div *ngIf="activeCameraFeed" class="absolute inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm" (click)="closeCameraFeed()">
    <div class="bg-white p-2 rounded-xl shadow-2xl max-w-2xl w-full border border-slate-200" (click)="$event.stopPropagation()">
      <div class="flex justify-between items-center mb-2 px-2">
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
          <span class="text-slate-800 font-bold">C√¢mera Escrit√≥rio - Ao Vivo</span>
        </div>
        <button (click)="closeCameraFeed()" class="text-slate-400 hover:text-slate-600">‚úï</button>
      </div>
      <div class="aspect-video bg-black rounded-lg overflow-hidden relative">
        <!-- Placeholder for Camera Feed -->
        <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExb3V5eGk2eGk2eGk2eGk2eGk2eGk2eGk2eGk2eGk2eGk2eGk2/L1R1TVOXXGh2w/giphy.gif" 
             alt="Camera Feed" 
             class="w-full h-full object-cover opacity-50">
        <div class="absolute inset-0 flex items-center justify-center">
           <div class="text-slate-500 font-mono">SINAL DA C√ÇMERA</div>
        </div>
        <div class="absolute bottom-4 right-4 text-white font-mono text-sm bg-black/50 px-2 rounded">
          {{ 'REC' }}
        </div>
      </div>
    </div>
  </div>
</div>
